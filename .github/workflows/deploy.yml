name: Build and Deploy Android App to Device via Tailscale

# Trigger on push to main branch or manual workflow dispatch
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up JDK 17 (recommended for Android development)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Step 3: Set up Android SDK
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # Step 4: Grant execute permission to gradlew
      - name: Grant execute permission to gradlew
        run: chmod +x ./gradlew

      # Step 5: Build the debug APK
      - name: Build Debug APK
        run: ./gradlew assembleDebug

      # Step 6: Locate the built APK
      - name: Locate APK
        id: locate_apk
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name '*.apk' | head -n 1)
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "Found APK at: $APK_PATH"

      # Step 7: Join the Tailscale tailnet
      # Prerequisites:
      # - The Android device must have Tailscale running and connected to the same tailnet
      # - Tailnet ACLs must allow traffic from tag:ci to the device's port 5555
      # - Repository secrets needed: TS_OAUTH_CLIENT_ID, TS_OAUTH_SECRET
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      # Optional: Ping the Android device for verification
      # Uses continue-on-error so the workflow doesn't fail if ping fails
      - name: Verify Tailscale connection to Android device
        continue-on-error: true
        run: |
          echo "Attempting to ping Android device at ${{ secrets.ANDROID_TAILSCALE_HOST }}"
          ping -c 3 ${{ secrets.ANDROID_TAILSCALE_HOST }} || echo "Ping failed, but continuing..."

      # Step 8: Install ADB tools
      - name: Install ADB tools
        run: |
          sudo apt-get update
          sudo apt-get install -y android-tools-adb android-tools-fastboot

      # Step 9: Connect to Android device over Tailscale
      # Prerequisites:
      # - ADB over TCP must be enabled on the device (run 'adb tcpip 5555' once)
      # - Repository secret needed: ANDROID_TAILSCALE_HOST (Tailscale IP or hostname like my-phone.tailnet.ts.net or 100.x.y.z)
      - name: Connect to Android device via ADB over Tailscale
        run: |
          echo "Connecting to Android device at ${{ secrets.ANDROID_TAILSCALE_HOST }}:5555"
          adb connect ${{ secrets.ANDROID_TAILSCALE_HOST }}:5555
          sleep 5
          adb devices

      # Step 10: Install the APK on the device
      - name: Install APK on Android device
        run: |
          echo "Installing APK: $APK_PATH"
          adb install -r $APK_PATH
          echo "APK installed successfully!"

      # Optional: Verify installation and Android version
      - name: Verify installation
        run: |
          echo "Verifying app installation..."
          adb shell pm list packages | grep com.example.helloworld
          echo "Android version on device:"
          adb shell getprop ro.build.version.release

      # Optional: Launch the app (uncomment to enable)
      # - name: Launch the app
      #   run: |
      #     echo "Launching HelloWorld app..."
      #     adb shell am start -n com.example.helloworld/.MainActivity

      # Cleanup: Disconnect from ADB
      - name: Disconnect from ADB
        if: always()
        run: |
          adb disconnect ${{ secrets.ANDROID_TAILSCALE_HOST }}:5555 || true

